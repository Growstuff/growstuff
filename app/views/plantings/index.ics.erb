<%
# TODO Refactor to a Planting <-> Ical view class?
cal = Icalendar::Calendar.new
cal.ip_name = "Plantings for #{@owner.login_name}"
@plantings.each do |planting|

  event = Icalendar::Event.new

  lines = []
  lines << "Quantity: #{planting['quantity'] ? planting['quantity'] : 'unknown' }"
  lines << "Planted on: #{planting['planted_at'] ? planting['planted_at'] : 'unknown' }"
  lines << "Sunniness: #{planting['sunniness'] ? planting['sunniness'] : 'unknown' }"
  lines << "Planted from: #{planting['planted_from'] ? planting['planted_from'] : 'unknown' }"
  lines << "First harvest from: #{planting['first_harvest_predicted_at'] ? planting['first_harvest_predicted_at'] : 'unknown' }"
  lines << "Last harvest from: #{planting['last_harvest_predicted_at'] ? planting['last_harvest_predicted_at'] : 'unknown' }"
  lines << "Finish predicted at: #{planting['finish_predicted_at'] ? planting['finish_predicted_at'] : 'unknown'}"
  lines << "Finished at: #{planting['finished_at'] ? planting['finished_at'] : 'unknown' }"

  lines << planting.description
  event.dtstart     = Time.at(planting['created_at'])
  event.dtend       = planting['finished_at']&.to_date || planting['finish_predicted_at']&.to_date || planting['last_harvest_predicted_at']&.to_date
  event.summary     = planting['crop_name']
  event.description = lines.join("\n")
  event.ip_class    = "PUBLIC"
  event.url = planting_url(slug: planting['slug'])

  cal.add_event(event)

  # Do we want to add a generic TODO for harvests? https://icalendar.org/iCalendar-RFC-5545/3-6-2-to-do-component.html
  # Do we want a VALARM from first harvest?
end
cal.publish
%>
<%= cal.to_ical %>
