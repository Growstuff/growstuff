<%
# TODO Refactor to a Planting <-> Ical view class?
cal = Icalendar::Calendar.new
@plantings.each do |planting|

  event = Icalendar::Event.new

  lines = []
  lines << "Quantity: #{planting['quantity'] ? planting['quantity'] : 'unknown' }"
  lines << "Planted on: #{planting['planted_at'] ? planting['planted_at'] : 'unknown' }"
  lines << "Sunniness: #{planting['sunniness'] ? planting['sunniness'] : 'unknown' }"
  lines << "Planted from: #{planting['planted_from'] ? planting['planted_from'] : 'unknown' }"
  lines << "First harvest from: #{planting['first_harvest_predicted_at'] ? planting['first_harvest_predicted_at'] : 'unknown' }"
  lines << "Last harvest from: #{planting['last_harvest_predicted_at'] ? planting['last_harvest_predicted_at'] : 'unknown' }"
  lines << "Finished at: #{planting['finished_at'] ? planting['finished_at'] : 'unknown' }"

  lines << planting.description
  event.dtstart     = Time.at(planting['created_at'])
  event.dtend       = planting['finished_at']&.to_date || planting['last_harvest_predicted_at']&.to_date 
  event.summary     = "#{planting['crop']} in #{planting['location']}"
  event.description = lines.join("\n")
  event.ip_class    = "PRIVATE"
  event.url = planting_url(slug: planting['slug'])

  cal.add_event(event)
end
cal.publish
%>
<%= cal.to_ical %>